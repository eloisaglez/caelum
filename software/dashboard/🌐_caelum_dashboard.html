<!DOCTYPE html>
<html lang="es">
<head>
    <title>CANSAT: CAELUM - MISSION CONTROL</title>
    <meta charset="utf-8">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', 'Roboto', monospace;
            background: #101010; color: #eee; height: 100vh;
            overflow: hidden; display: flex; flex-direction: column;
        }
        .header {
            height: 55px; background: #000; border-bottom: 2px solid #ffd700;
            display: flex; align-items: center; justify-content: space-between; padding: 0 15px; z-index: 10;
        }
        .logo-ies {
            background: #fff; color: #000; padding: 4px 12px; font-weight: 900;
            border-radius: 4px; font-size: 0.8rem; text-transform: uppercase;
        }
        .mission-selector {
            background: #1a1a1a; color: #ffd700; border: 1px solid #ffd700;
            padding: 6px 12px; font-size: 0.85rem; font-weight: bold; border-radius: 4px; cursor: pointer;
        }
        .main-grid {
            display: grid; grid-template-columns: 50% 50%; height: calc(100vh - 55px);
            gap: 4px; background: #2a2a2a;
        }
        .left-panel { background: #000; display: grid; grid-template-rows: 55% 45%; gap: 4px; }
        #mapa { width: 100%; height: 100%; background: #111; }
        .instruments-deck { background: #080808; display: flex; border-top: 2px solid #333; }
        .deck-3d { flex: 1.2; position: relative; overflow: hidden; background: radial-gradient(circle at center, #222 0%, #000 100%); }
        .deck-gauges { flex: 0.8; display: flex; flex-direction: column; justify-content: center; gap: 8px; padding: 10px; }
        .gauge-row { display: flex; align-items: center; justify-content: space-between; padding: 8px 15px; background: #111; border-radius: 6px; border-left: 4px solid #333; }
        canvas.gauge { width: 70px; height: 70px; }
        .g-val { font-family: monospace; color: #ffd700; font-weight: bold; }
        .right-panel { background: #141414; padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        .kpi-row { display: flex; gap: 10px; height: 65px; }
        .kpi-box { flex: 1; background: #222; padding: 5px 12px; border-radius: 4px; border-bottom: 3px solid #444; }
        .kpi-val { font-size: 1.4rem; font-weight: bold; }
        .kpi-lbl { font-size: 0.6rem; color: #888; text-transform: uppercase; }
        .charts-group { flex: 1; display: grid; grid-template-rows: repeat(3, 1fr); gap: 6px; }
        .chart-mini { background: #1a1a1a; border-radius: 4px; border: 1px solid #333; display: flex; flex-direction: column; }
        .panel-header { background: #252525; padding: 4px 10px; font-size: 0.75rem; color: #bbb; font-weight: bold; }
        .chart-body { flex: 1; position: relative; }
        .gas-panel { height: 130px; background: #111; border-radius: 6px; padding: 10px; display: flex; flex-direction: column; justify-content: space-around; }
        .bar-row { display: flex; align-items: center; }
        .bar-lbl { width: 60px; font-size: 0.7rem; color: #aaa; }
        .bar-bg { flex: 1; background: #222; height: 10px; border-radius: 5px; margin: 0 10px; overflow: hidden; }
        .bar-fill { height: 100%; transition: width 0.4s; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>

    <div class="header">
        <div style="display: flex; align-items: center; gap: 15px;">
            <div class="logo-ies">IES DIEGO VEL√ÅZQUEZ</div>
            <div style="font-weight: bold;"><span style="color:#ffd700">CAELUM</span> | MISSION CONTROL</div>
        </div>
        <select id="missionSelect" class="mission-selector">
            <option value="replay">‚è™ REPLAY VUELO</option>
            <option value="simulacion">‚úàÔ∏è SIMULACI√ìN</option>
            <option value="telemetria">üì° LIVE</option>
        </select>
    </div>

    <div class="main-grid">
        <div class="left-panel">
            <div id="mapa"></div>
            <div class="instruments-deck">
                <div class="deck-3d" id="cont-3d"></div>
                <div class="deck-gauges">
                    <div class="gauge-row" style="border-left-color: #00ffff;"><span style="font-size:0.7rem">ACC X</span><canvas id="g-x" class="gauge"></canvas><span class="g-val" id="txt-x">0.0</span></div>
                    <div class="gauge-row" style="border-left-color: #00ff00;"><span style="font-size:0.7rem">ACC Y</span><canvas id="g-y" class="gauge"></canvas><span class="g-val" id="txt-y">0.0</span></div>
                    <div class="gauge-row" style="border-left-color: #ff4444;"><span style="font-size:0.7rem">ACC Z</span><canvas id="g-z" class="gauge"></canvas><span class="g-val" id="txt-z">1.0</span></div>
                </div>
            </div>
        </div>
        <div class="right-panel">
            <div class="kpi-row">
                <div class="kpi-box" style="border-bottom-color:#fff"><div class="kpi-lbl">ALTITUD</div><div class="kpi-val" id="val-alt">0</div></div>
                <div class="kpi-box" style="border-bottom-color:#00aaff"><div class="kpi-lbl">PRESI√ìN</div><div class="kpi-val" id="val-press">0</div></div>
                <div class="kpi-box" style="border-bottom-color:#ff9900"><div class="kpi-lbl">TEMP</div><div class="kpi-val" id="val-temp">0</div></div>
            </div>
            <div class="charts-group">
                <div class="chart-mini"><div class="panel-header">ALTITUD (m)</div><div class="chart-body"><canvas id="c-alt"></canvas></div></div>
                <div class="chart-mini"><div class="panel-header">PRESI√ìN (hPa)</div><div class="chart-body"><canvas id="c-press"></canvas></div></div>
                <div class="chart-mini"><div class="panel-header">TEMPERATURA (¬∫C)</div><div class="chart-body"><canvas id="c-temp"></canvas></div></div>
            </div>
            <div class="gas-panel">
                <div class="bar-row"><span class="bar-lbl">CO2</span><div class="bar-bg"><div id="b-co2" class="bar-fill"></div></div><span id="n-co2" style="font-size:0.8rem; font-family:monospace">400</span></div>
                <div class="bar-row"><span class="bar-lbl">PM 2.5</span><div class="bar-bg"><div id="b-pm25" class="bar-fill"></div></div><span id="n-pm25" style="font-size:0.8rem; font-family:monospace">0</span></div>
                <div class="bar-row"><span class="bar-lbl">PM 10</span><div class="bar-bg"><div id="b-pm10" class="bar-fill"></div></div><span id="n-pm10" style="font-size:0.8rem; font-family:monospace">0</span></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, onValue, query, orderByKey, limitToLast } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCA2OZ8OoN41hykh5PbSZ9eoPths-iuDfE",
            databaseURL: "https://cansat-66d98-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "cansat-66d98",
            appId: "1:219640958295:web:42837107ac3f60e3e18212"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // MAPA
        const map = L.map('mapa', {zoomControl:false}).setView([40.4052, -3.9931], 16);
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}').addTo(map);
        let marker = null;
        let path = L.polyline([], {color:'#ffd700', weight:3}).addTo(map);
        let points = [];

        // 3D
        const cont3d = document.getElementById('cont-3d');
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(45, cont3d.clientWidth/cont3d.clientHeight, 0.1, 100);
        const renderer = new THREE.WebGLRenderer({alpha:true, antialias:true});
        renderer.setSize(cont3d.clientWidth, cont3d.clientHeight);
        cont3d.appendChild(renderer.domElement);
        const geometry = new THREE.CylinderGeometry(0.8, 0.8, 2.2, 32);
        const material = new THREE.MeshPhongMaterial({color: 0xffd700, shininess: 80});
        const cansat = new THREE.Mesh(geometry, material);
        scene.add(cansat);
        const light = new THREE.DirectionalLight(0xffffff, 2); light.position.set(5,5,5); scene.add(light);
        scene.add(new THREE.AmbientLight(0x404040)); camera.position.z = 5;
        function anim() { requestAnimationFrame(anim); renderer.render(scene, camera); } anim();

        // CHARTS & GAUGES
        const createChart = (id, color) => new Chart(document.getElementById(id), {
            type:'line', data:{labels:Array(30).fill(''), datasets:[{data:[], borderColor:color, borderWidth:2, pointRadius:0, tension:0.3}]},
            options:{responsive:true, maintainAspectRatio:false, animation:false, plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{grid:{color:'#222'}} }}
        });
        const cAlt = createChart('c-alt', '#fff'), cPress = createChart('c-press', '#00aaff'), cTemp = createChart('c-temp', '#ff9900');
        
        function drawG(id, val, col) {
            const ctx = document.getElementById(id).getContext('2d');
            ctx.canvas.width = 70; ctx.canvas.height = 70;
            ctx.clearRect(0,0,70,70);
            ctx.beginPath(); ctx.arc(35,35,30,0,Math.PI*2); ctx.strokeStyle='#222'; ctx.lineWidth=5; ctx.stroke();
            ctx.beginPath(); ctx.arc(35,35,30,-Math.PI/2, (-Math.PI/2) + (Math.min(Math.abs(val)/15, 1)*Math.PI*2)); ctx.strokeStyle=col; ctx.stroke();
        }

        // CONEXI√ìN
        let listener = null;
        function connect(folder) {
            if(listener) listener();
            points = []; path.setLatLngs([]); if(marker) map.removeLayer(marker); marker = null;

            const q = query(ref(database, `cansat/${folder}`), orderByKey(), limitToLast(1));
            listener = onValue(q, (snap) => {
                snap.forEach(s => {
                    const d = s.val();
                    
                    // --- AQU√ç EST√Å EL CAMBIO: USAMOS TUS NOMBRES DE PYTHON ---
                    
                    // Rotaci√≥n (Usa rotX y rotZ que env√≠a tu Python)
                    cansat.rotation.x = (d.rotX || d.accelX || 0) * (Math.PI/180);
                    cansat.rotation.z = (d.rotZ || d.accelY || 0) * (Math.PI/180);
                    
                    // Mapa (Usa latitud y longitud)
                    if(d.latitud && d.longitud) {
                        const pos = [d.latitud, d.longitud];
                        if(!marker) marker = L.marker(pos).addTo(map);
                        marker.setLatLng(pos); map.panTo(pos);
                        points.push(pos); path.setLatLngs(points);
                    }
                    
                    // Gauges (Usa accelX, accelY, accelZ)
                    drawG('g-x', d.accelX || 0, '#00ffff'); drawG('g-y', d.accelY || 0, '#00ff00'); drawG('g-z', d.accelZ || 0, '#ff4444');
                    document.getElementById('txt-x').innerText = (d.accelX||0).toFixed(1);
                    document.getElementById('txt-y').innerText = (d.accelY||0).toFixed(1);
                    document.getElementById('txt-z').innerText = (d.accelZ||1).toFixed(1);
                    
                    // KPIs (Usa altitud, presion, temp)
                    document.getElementById('val-alt').innerText = (d.altitud||0).toFixed(0);
                    document.getElementById('val-press').innerText = (d.presion||0).toFixed(0);
                    document.getElementById('val-temp').innerText = (d.temp||0).toFixed(1);
                    
                    // Gr√°ficas
                    const push = (c, v) => { c.data.datasets[0].data.push(v); if(c.data.datasets[0].data.length>30) c.data.datasets[0].data.shift(); c.update(); };
                    push(cAlt, d.altitud); push(cPress, d.presion); push(cTemp, d.temp);
                    
                    // Barras de Gases (CO2, PM)
                    const bar = (id, nId, v, m, col) => { 
                        document.getElementById(id).style.width = Math.min((v/m)*100, 100)+'%'; 
                        document.getElementById(id).style.backgroundColor = col;
                        document.getElementById(nId).innerText = (v||0).toFixed(0);
                    };
                    bar('b-co2', 'n-co2', d.co2||400, 1500, (d.co2>1000?'#ff4444':'#00ff00'));
                    bar('b-pm25', 'n-pm25', d.pm2_5||0, 100, '#00aaff');
                    bar('b-pm10', 'n-pm10', d.pm10||0, 150, '#e91e63');
                });
            });
        }
        
        const selector = document.getElementById('missionSelect');
        selector.onchange = (e) => connect(e.target.value);
        
        // Iniciar con el valor del selector (por defecto Replay)
        connect(selector.value);
    </script>
</body>
</html>
