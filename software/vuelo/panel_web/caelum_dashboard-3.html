<!DOCTYPE html>
<html lang="es">
<head>
    <title>CANSAT: CAELUM - MISSION CONTROL</title>
    <meta charset="utf-8">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', 'Roboto', monospace;
            background: #101010; color: #eee; height: 100vh;
            overflow: hidden; display: flex; flex-direction: column;
        }
        .header {
            height: 55px; background: #000; border-bottom: 2px solid #ffd700;
            display: flex; align-items: center; justify-content: space-between; padding: 0 15px; z-index: 10;
        }
        .logo-ies {
            background: #fff; color: #000; padding: 4px 12px; font-weight: 900;
            border-radius: 4px; font-size: 0.8rem; text-transform: uppercase;
        }
        .mission-selector {
            background: #1a1a1a; color: #ffd700; border: 1px solid #ffd700;
            padding: 6px 12px; font-size: 0.85rem; font-weight: bold; border-radius: 4px; cursor: pointer;
        }
        .main-grid {
            display: grid; grid-template-columns: 50% 50%; height: calc(100vh - 55px);
            gap: 4px; background: #2a2a2a;
        }
        .left-panel { background: #000; display: grid; grid-template-rows: 55% 45%; gap: 4px; }
        #mapa { width: 100%; height: 100%; background: #111; }
        .instruments-deck { background: #080808; display: flex; border-top: 2px solid #333; }
        .deck-3d { flex: 1.2; position: relative; overflow: hidden; background: radial-gradient(circle at center, #222 0%, #000 100%); }
        .deck-gauges { flex: 0.8; display: flex; flex-direction: column; justify-content: center; gap: 8px; padding: 10px; }
        .gauge-row { display: flex; align-items: center; justify-content: space-between; padding: 8px 15px; background: #111; border-radius: 6px; border-left: 4px solid #333; }
        canvas.gauge { width: 70px; height: 70px; }
        .g-val { font-family: monospace; color: #ffd700; font-weight: bold; }
        .right-panel { background: #141414; padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        .kpi-row { display: flex; gap: 10px; height: 65px; }
        .kpi-box { flex: 1; background: #222; padding: 5px 12px; border-radius: 4px; border-bottom: 3px solid #444; }
        .kpi-val { font-size: 1.4rem; font-weight: bold; }
        .kpi-lbl { font-size: 0.6rem; color: #888; text-transform: uppercase; }
        .charts-group { flex: 1; display: grid; grid-template-rows: repeat(3, 1fr); gap: 6px; }
        .chart-mini { background: #1a1a1a; border-radius: 4px; border: 1px solid #333; display: flex; flex-direction: column; }
        .panel-header { background: #252525; padding: 4px 10px; font-size: 0.75rem; color: #bbb; font-weight: bold; }
        .chart-body { flex: 1; position: relative; }
        .gas-panel { height: 130px; background: #111; border-radius: 6px; padding: 10px; display: flex; flex-direction: column; justify-content: space-around; }
        .bar-row { display: flex; align-items: center; }
        .bar-lbl { width: 60px; font-size: 0.7rem; color: #aaa; }
        .bar-bg { flex: 1; background: #222; height: 10px; border-radius: 5px; margin: 0 10px; overflow: hidden; }
        .bar-fill { height: 100%; transition: width 0.4s; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>

    <div class="header">
        <div style="display: flex; align-items: center; gap: 15px;">
            <div class="logo-ies">IES DIEGO VEL√ÅZQUEZ</div>
            <div style="font-weight: bold;"><span style="color:#ffd700">CAELUM</span> | MISSION CONTROL</div>
        </div>
        <select id="missionSelect" class="mission-selector">
            <option value="replay">‚è™ REPLAY VUELO</option>
            <option value="simulacion">‚úàÔ∏è SIMULACI√ìN</option>
            <option value="telemetria">üì° LIVE</option>
        </select>
    </div>

    <div class="main-grid">
        <div class="left-panel">
            <div id="mapa"></div>
            <div class="instruments-deck">
                <div class="deck-3d" id="cont-3d">
                    <div style="position:absolute; bottom:6px; left:8px; font-size:0.65rem; font-family:monospace; line-height:1.6; z-index:2; pointer-events:none;">
                        <span style="color:#ff3333">‚ñ† X</span>&nbsp;
                        <span style="color:#33ff33">‚ñ† Y</span>&nbsp;
                        <span style="color:#3399ff">‚ñ† Z</span>
                    </div>
                </div>
                <div class="deck-gauges">
                    <div class="gauge-row" style="border-left-color: #00ffff;"><span style="font-size:0.7rem">ACC X</span><canvas id="g-x" class="gauge"></canvas><span class="g-val" id="txt-x">0.0</span></div>
                    <div class="gauge-row" style="border-left-color: #00ff00;"><span style="font-size:0.7rem">ACC Y</span><canvas id="g-y" class="gauge"></canvas><span class="g-val" id="txt-y">0.0</span></div>
                    <div class="gauge-row" style="border-left-color: #ff4444;"><span style="font-size:0.7rem">ACC Z</span><canvas id="g-z" class="gauge"></canvas><span class="g-val" id="txt-z">1.0</span></div>
                </div>
            </div>
        </div>
        <div class="right-panel">
            <div class="kpi-row">
                <div class="kpi-box" style="border-bottom-color:#fff"><div class="kpi-lbl">ALTITUD (m)</div><div class="kpi-val" id="val-alt">0</div></div>
                <div class="kpi-box" style="border-bottom-color:#00aaff"><div class="kpi-lbl">PRESI√ìN (hPa)</div><div class="kpi-val" id="val-press">0</div></div>
                <div class="kpi-box" style="border-bottom-color:#ff9900"><div class="kpi-lbl">TEMP HS300x (¬∞C)</div><div class="kpi-val" id="val-temp">0</div></div>
            </div>
            <!-- Validaci√≥n cruzada T + Fase -->
            <div style="display:flex; gap:6px; height:48px;">
                <div class="kpi-box" style="border-bottom-color:#4488ff; flex:1">
                    <div class="kpi-lbl">TEMP SCD40</div>
                    <div style="font-size:1.05rem; font-weight:bold; font-family:monospace; color:#4488ff" id="val-temp-scd">‚Äî</div>
                </div>
                <div class="kpi-box" style="border-bottom-color:#44cc44; flex:1">
                    <div class="kpi-lbl">TEMP LPS22HB</div>
                    <div style="font-size:1.05rem; font-weight:bold; font-family:monospace; color:#44cc44" id="val-temp-lps">‚Äî</div>
                </div>
                <div class="kpi-box" style="border-bottom-color:#888; flex:1">
                    <div class="kpi-lbl">VALIDACI√ìN ŒîT</div>
                    <div style="font-size:1.0rem; font-weight:bold; font-family:monospace" id="val-delta-t">‚Äî</div>
                </div>
                <div class="kpi-box" style="border-bottom-color:#ffd700; flex:1">
                    <div class="kpi-lbl">FASE</div>
                    <div style="font-size:0.85rem; font-weight:bold; color:#ffd700; margin-top:2px" id="val-fase">‚Äî</div>
                </div>
            </div>
            <div class="charts-group">
                <div class="chart-mini"><div class="panel-header">ALTITUD (m)</div><div class="chart-body"><canvas id="c-alt"></canvas></div></div>
                <div class="chart-mini"><div class="panel-header">PRESI√ìN (hPa)</div><div class="chart-body"><canvas id="c-press"></canvas></div></div>
                <div class="chart-mini"><div class="panel-header">TEMPERATURA (¬∫C)</div><div class="chart-body"><canvas id="c-temp"></canvas></div></div>
            </div>
            <div class="gas-panel" style="height:160px;">
                <div style="font-size:0.65rem; color:#888; margin-bottom:4px; letter-spacing:1px">CO‚ÇÇ TRAZADOR ESTABILIDAD ATM. ¬∑ PM PERFIL VERTICAL</div>
                <div class="bar-row"><span class="bar-lbl">CO‚ÇÇ (ppm)</span><div class="bar-bg"><div id="b-co2" class="bar-fill"></div></div><span id="n-co2" style="font-size:0.8rem; font-family:monospace">420</span></div>
                <div class="bar-row"><span class="bar-lbl">PM 1.0</span><div class="bar-bg"><div id="b-pm1_0" class="bar-fill"></div></div><span id="n-pm1_0" style="font-size:0.8rem; font-family:monospace">0</span></div>
                <div class="bar-row"><span class="bar-lbl">PM 2.5</span><div class="bar-bg"><div id="b-pm25" class="bar-fill"></div></div><span id="n-pm25" style="font-size:0.8rem; font-family:monospace">0</span></div>
                <div class="bar-row"><span class="bar-lbl">PM 10</span><div class="bar-bg"><div id="b-pm10" class="bar-fill"></div></div><span id="n-pm10" style="font-size:0.8rem; font-family:monospace">0</span></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, onValue, query, orderByKey, limitToLast } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCA2OZ8OoN41hykh5PbSZ9eoPths-iuDfE",
            databaseURL: "https://cansat-66d98-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "cansat-66d98",
            appId: "1:219640958295:web:42837107ac3f60e3e18212"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // MAPA
        const map = L.map('mapa', {zoomControl:false}).setView([40.4052, -3.9931], 16);
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}').addTo(map);
        let marker = null;
        let path = L.polyline([], {color:'#ffd700', weight:3}).addTo(map);
        let points = [];

        // 3D
        const cont3d = document.getElementById('cont-3d');
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(45, cont3d.clientWidth/cont3d.clientHeight, 0.1, 100);
        const renderer = new THREE.WebGLRenderer({alpha:true, antialias:true});
        renderer.setSize(cont3d.clientWidth, cont3d.clientHeight);
        cont3d.appendChild(renderer.domElement);
        const geometry = new THREE.CylinderGeometry(0.8, 0.8, 2.2, 32);

        // Material suave sin sombra marcada
        const material = new THREE.MeshLambertMaterial({color: 0xffd700});
        const cansat = new THREE.Mesh(geometry, material);
        scene.add(cansat);

        // Iluminaci√≥n suave por todos lados ‚Äî sin sombra marcada
        scene.add(new THREE.AmbientLight(0xffffff, 0.7));
        const light1 = new THREE.DirectionalLight(0xffffff, 0.6); light1.position.set(5, 5, 5);   scene.add(light1);
        const light2 = new THREE.DirectionalLight(0xffffff, 0.4); light2.position.set(-5, -3, -5); scene.add(light2);
        const light3 = new THREE.DirectionalLight(0xffffff, 0.3); light3.position.set(0, 5, -5);   scene.add(light3);

        // Ejes de coordenadas X (rojo), Y (verde), Z (azul)
        const ejeLong = 1.6;
        const grosor  = 0.04;
        function crearEje(color, dir) {
            const mat = new THREE.MeshBasicMaterial({color});
            const geo = new THREE.CylinderGeometry(grosor, grosor, ejeLong, 8);
            const eje = new THREE.Mesh(geo, mat);
            if (dir === 'x') { eje.rotation.z = Math.PI / 2; eje.position.x = ejeLong / 2; }
            if (dir === 'z') { eje.rotation.x = Math.PI / 2; eje.position.z = ejeLong / 2; }
            if (dir === 'y') { eje.position.y = ejeLong / 2; }
            // Punta de flecha
            const cono = new THREE.Mesh(new THREE.ConeGeometry(grosor * 2.5, 0.2, 8), mat);
            if (dir === 'x') { cono.rotation.z = -Math.PI / 2; cono.position.x = ejeLong; }
            if (dir === 'z') { cono.rotation.x =  Math.PI / 2; cono.position.z = ejeLong; }
            if (dir === 'y') { cono.position.y = ejeLong; }
            const grupo = new THREE.Group();
            grupo.add(eje); grupo.add(cono);
            return grupo;
        }
        scene.add(crearEje(0xff3333, 'x'));  // X rojo
        scene.add(crearEje(0x33ff33, 'y'));  // Y verde
        scene.add(crearEje(0x3399ff, 'z'));  // Z azul

        camera.position.set(2, 2, 5); camera.lookAt(0, 0, 0);
        function anim() { requestAnimationFrame(anim); renderer.render(scene, camera); } anim();

        // CHARTS & GAUGES
        const createChart = (id, color) => new Chart(document.getElementById(id), {
            type:'line', data:{labels:Array(30).fill(''), datasets:[{data:[], borderColor:color, borderWidth:2, pointRadius:0, tension:0.3}]},
            options:{responsive:true, maintainAspectRatio:false, animation:false, plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{grid:{color:'#222'}} }}
        });
        const cAlt = createChart('c-alt', '#fff'), cPress = createChart('c-press', '#00aaff'), cTemp = createChart('c-temp', '#ff9900');
        
        function drawG(id, val, col) {
            const ctx = document.getElementById(id).getContext('2d');
            ctx.canvas.width = 70; ctx.canvas.height = 70;
            ctx.clearRect(0,0,70,70);
            ctx.beginPath(); ctx.arc(35,35,30,0,Math.PI*2); ctx.strokeStyle='#222'; ctx.lineWidth=5; ctx.stroke();
            ctx.beginPath(); ctx.arc(35,35,30,-Math.PI/2, (-Math.PI/2) + (Math.min(Math.abs(val)/15, 1)*Math.PI*2)); ctx.strokeStyle=col; ctx.stroke();
        }

        // CONEXI√ìN
        let listener = null;
        let tsConexion = 0;   // timestamp de cuando conectamos ‚Äî ignoramos datos anteriores
        function connect(folder) {
            if(listener) listener();
            points = []; path.setLatLngs([]); if(marker) map.removeLayer(marker); marker = null;
            tsConexion = Date.now() / 1000;   // en segundos, igual que el campo timestamp del CSV

            const q = query(ref(database, `cansat/${folder}`), orderByKey(), limitToLast(1));
            listener = onValue(q, (snap) => {
                snap.forEach(s => {
                    const d = s.val();

                    // Ignorar datos que ya estaban en Firebase antes de conectar
                    if ((d.timestamp || 0) < tsConexion - 5) return;

                    // Rotaci√≥n 3D (giroscopio ‚Äî nombres reales del CSV)
                    cansat.rotation.x = (d.gyro_x || 0) * (Math.PI / 180);
                    cansat.rotation.z = (d.gyro_z || 0) * (Math.PI / 180);

                    // Mapa GPS (campos reales: lat, lon)
                    if (d.lat && d.lon) {
                        const pos = [d.lat, d.lon];
                        if (!marker) marker = L.marker(pos).addTo(map);
                        marker.setLatLng(pos); map.panTo(pos);
                        points.push(pos); path.setLatLngs(points);
                    }

                    // Gauges IMU (campos reales: accel_x, accel_y, accel_z)
                    drawG('g-x', d.accel_x || 0, '#00ffff');
                    drawG('g-y', d.accel_y || 0, '#00ff00');
                    drawG('g-z', d.accel_z || 0, '#ff4444');
                    document.getElementById('txt-x').innerText = (d.accel_x || 0).toFixed(1);
                    document.getElementById('txt-y').innerText = (d.accel_y || 0).toFixed(1);
                    document.getElementById('txt-z').innerText = (d.accel_z || 1).toFixed(1);

                    // KPIs (campos reales: alt, presion, temp_hs)
                    document.getElementById('val-alt').innerText   = (d.alt    || 0).toFixed(0);
                    document.getElementById('val-press').innerText = (d.presion || 0).toFixed(0);
                    document.getElementById('val-temp').innerText  = (d.temp_hs || 0).toFixed(1);

                    // Validaci√≥n cruzada temperatura (3 sensores)
                    document.getElementById('val-temp-scd').innerText = (d.temp_scd || 0).toFixed(1);
                    document.getElementById('val-temp-lps').innerText = (d.temp_lps || 0).toFixed(1);
                    const deltaT = Math.abs((d.temp_hs || 0) - (d.temp_scd || 0));
                    const elDelta = document.getElementById('val-delta-t');
                    elDelta.innerText = 'ŒîT ' + deltaT.toFixed(1) + '¬∞C';
                    elDelta.style.color = deltaT > 3.0 ? '#ff4444' : '#00ff88';

                    // Fase de vuelo
                    const faseEl = document.getElementById('val-fase');
                    if (faseEl) faseEl.innerText = (d.fase || '‚Äî').toUpperCase();

                    // Gr√°ficas
                    const push = (c, v) => { c.data.datasets[0].data.push(v); if (c.data.datasets[0].data.length > 30) c.data.datasets[0].data.shift(); c.update(); };
                    push(cAlt, d.alt); push(cPress, d.presion); push(cTemp, d.temp_hs);

                    // Barras de gases y part√≠culas
                    const bar = (id, nId, v, m, col) => {
                        document.getElementById(id).style.width = Math.min((v / m) * 100, 100) + '%';
                        document.getElementById(id).style.backgroundColor = col;
                        document.getElementById(nId).innerText = (v || 0).toFixed(0);
                    };

                    // CO‚ÇÇ ‚Äî trazador de estabilidad atmosf√©rica
                    // ~420 ppm = bien mezclado (verde). Desviaci√≥n = capas detectadas.
                    const co2    = d.co2 || 420;
                    const co2Dev = Math.abs(co2 - 420);
                    const co2Col = co2Dev < 20 ? '#00ff88' : co2Dev < 60 ? '#ffaa00' : '#ff4444';
                    bar('b-co2', 'n-co2', co2, 600, co2Col);

                    // PM ‚Äî perfil vertical de part√≠culas (colores OMS)
                    const pm25    = d.pm2_5 || 0;
                    const pm25Col = pm25 < 12 ? '#00ff88' : pm25 < 35 ? '#ffaa00' : '#ff4444';
                    bar('b-pm1_0', 'n-pm1_0', d.pm1_0 || 0, 80,  '#00aaff');
                    bar('b-pm25',  'n-pm25',  pm25,          100, pm25Col);
                    bar('b-pm10',  'n-pm10',  d.pm10  || 0, 150, '#e91e63');
                });
            });
        }

        const selector = document.getElementById('missionSelect');
        selector.onchange = (e) => connect(e.target.value);
        connect(selector.value);
    </script>
</body>
</html>
